<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:HlaeObsTools.ViewModels.Docks"
             xmlns:ctrls="using:HlaeObsTools.Controls"
             xmlns:svg="using:Avalonia.Svg.Skia"
             xmlns:hud="using:HlaeObsTools.ViewModels.Hud"
             xmlns:conv="using:HlaeObsTools.Converters"
             xmlns:ac="clr-namespace:Avalonia.Controls;assembly=Avalonia.Controls"
             x:Class="HlaeObsTools.Views.Docks.VideoDisplayDockView"
             x:DataType="vm:VideoDisplayDockViewModel">
    <UserControl.Resources>
        <conv:BooleanToOpacityConverter x:Key="ActiveOpacityConverter"
                                        TrueOpacity="1"
                                        FalseOpacity="0.55" />
        <conv:BooleanToOpacityConverter x:Key="AliveOpacityConverter"
                                        TrueOpacity="1"
                                        FalseOpacity="0.35" />
        <conv:HudScaleConverter x:Key="HudScaleConverter"
                                BaseWidth="1600"
                                BaseHeight="900"
                                MinScale="0"
                                MaxScale="1" />

        <DataTemplate x:Key="WeaponChipTemplate" x:DataType="hud:HudWeaponViewModel">
            <Border Padding="4"
                    CornerRadius="4"
                    BorderThickness="1"
                    BorderBrush="{Binding AccentBrush}"
                    Background="#32000000"
                    Opacity="{Binding IsActive, Converter={StaticResource ActiveOpacityConverter}}"
                    Margin="2"
                    Width="{Binding ChipWidth}"
                    Height="28">
                <svg:Svg Path="{Binding IconPath}"
                         Width="{Binding IconSize}"
                         Height="{Binding IconSize}"
                         HorizontalAlignment="Center"
                         VerticalAlignment="Center" />
            </Border>
        </DataTemplate>

        <DataTemplate x:Key="PlayerCardTemplate" x:DataType="hud:HudPlayerCardViewModel">
            <Border Background="{Binding CardBackground}"
                    CornerRadius="8"
                    Padding="8"
                    Margin="0,6"
                    BorderBrush="#33FFFFFF"
                    BorderThickness="1"
                    Width="306"
                    Opacity="{Binding IsAlive, Converter={StaticResource AliveOpacityConverter}}">
                <StackPanel Spacing="6">
                    <Grid ColumnDefinitions="Auto,*,Auto,Auto" ColumnSpacing="8">
                        <Border Background="{Binding AccentBrush}"
                                Padding="6,3"
                                CornerRadius="4"
                                Width="32"
                                HorizontalAlignment="Left">
                            <TextBlock Text="{Binding DisplaySlot}"
                                       HorizontalAlignment="Center"
                                       FontWeight="Bold"
                                       Foreground="#0D1015" />
                        </Border>

                        <TextBlock Grid.Column="1"
                                   Text="{Binding Name}"
                                   FontWeight="SemiBold"
                                   Foreground="#E6E6E6"
                                   TextTrimming="CharacterEllipsis" />

                        <TextBlock Grid.Column="2"
                                   Text="{Binding ActiveAmmoText}"
                                   Foreground="{Binding AccentBrush}"
                                   FontWeight="Bold"
                                   FontSize="12"
                                   HorizontalAlignment="Center"
                                   VerticalAlignment="Center" />

                        <StackPanel Grid.Column="3"
                                    Orientation="Horizontal"
                                    Spacing="8"
                                    VerticalAlignment="Center">
                            <StackPanel Orientation="Horizontal" Spacing="4" VerticalAlignment="Center">
                                <svg:Svg Path="{Binding HealthIconPath}" Width="16" Height="16" />
                                <TextBlock Text="{Binding Health}" Foreground="#E6E6E6" FontWeight="Bold" />
                            </StackPanel>
                            <StackPanel Orientation="Horizontal" Spacing="4" VerticalAlignment="Center">
                                <svg:Svg Path="{Binding ArmorIconPath}" Width="16" Height="16" />
                                <TextBlock Text="{Binding Armor}" Foreground="#E6E6E6" />
                            </StackPanel>
                        </StackPanel>
                    </Grid>

                    <ProgressBar Minimum="0"
                                 Maximum="100"
                                 Value="{Binding Health}"
                                 Height="6"
                                 Foreground="{Binding AccentBrush}"
                                 Background="#303540"
                                 IsHitTestVisible="False" />

                    <ItemsControl ItemsSource="{Binding WeaponsAndGrenades}"
                                  ItemTemplate="{StaticResource WeaponChipTemplate}">
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <StackPanel Orientation="Horizontal" />
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>
                    </ItemsControl>
                </StackPanel>
            </Border>
        </DataTemplate>
    </UserControl.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Video display area -->
        <Grid Grid.Row="0" ClipToBounds="True">
            <Border Background="Black" Focusable="True"
                    x:Name="VideoContainer"
                    PointerPressed="VideoContainer_PointerPressed"
                    PointerReleased="VideoContainer_PointerReleased"
                    PointerMoved="VideoContainer_PointerMoved">
                <Grid>
                    <Viewbox Stretch="Uniform" IsVisible="{Binding !UseD3DHost}">
                        <Image Source="{Binding CurrentFrame}"
                               RenderOptions.BitmapInterpolationMode="LowQuality"
                               Stretch="None"/>
                    </Viewbox>

                    <!-- GPU shared texture (Avalonia visual - no airspace issues) -->
                    <Grid x:Name="SharedTextureWrapper"
                          IsVisible="{Binding UseD3DHost}"
                          HorizontalAlignment="Center"
                          VerticalAlignment="Center">
                        <Grid x:Name="SharedTextureAspect"
                              HorizontalAlignment="Center"
                              VerticalAlignment="Center">
                            <ctrls:D3DSharedTextureControl x:Name="SharedTextureControl"
                                                           HorizontalAlignment="Stretch"
                                                           VerticalAlignment="Stretch"
                                                           Focusable="True"/>
                        </Grid>
                    </Grid>

                    <!-- Freecam active indicator -->
                    <Border BorderBrush="Red"
                            BorderThickness="4"
                            IsVisible="{Binding IsFreecamActive}"
                            HorizontalAlignment="Stretch"
                            VerticalAlignment="Stretch"
                            IsHitTestVisible="False"/>

                    <!-- Freecam speed scale overlay -->
                    <Grid x:Name="SpeedScaleRegion"
                          HorizontalAlignment="Right"
                          VerticalAlignment="Top"
                          Margin="16"
                          IsHitTestVisible="False"
                          ac:Panel.ZIndex="5">
                        <Canvas x:Name="SpeedScaleCanvas"
                                HorizontalAlignment="Right"
                                VerticalAlignment="Stretch"
                                Margin="0,32,0,32">
                            <Canvas.Effect>
                                <DropShadowEffect
                                    Color="Black"
                                    BlurRadius="5"
                                    OffsetX="2"
                                    OffsetY="2"
                                    Opacity="0.5"/>
                            </Canvas.Effect>
                        </Canvas>
                    </Grid>
                </Grid>
            </Border>

            <!-- Built-in HUD overlay -->
            <Grid x:Name="HudOverlayHost"
                  Margin="8"
                  IsVisible="{Binding ShowNativeHud}"
                  IsHitTestVisible="False"
                  ClipToBounds="True"
                  ac:Panel.ZIndex="10">
                <ac:LayoutTransformControl HorizontalAlignment="Center"
                                           VerticalAlignment="Center"
                                           IsHitTestVisible="False">
                    <ac:LayoutTransformControl.LayoutTransform>
                        <ScaleTransform>
                            <ScaleTransform.ScaleX>
                                <MultiBinding Converter="{StaticResource HudScaleConverter}">
                                    <Binding ElementName="HudOverlayHost" Path="Bounds.Width" />
                                    <Binding ElementName="HudOverlayHost" Path="Bounds.Height" />
                                </MultiBinding>
                            </ScaleTransform.ScaleX>
                            <ScaleTransform.ScaleY>
                                <MultiBinding Converter="{StaticResource HudScaleConverter}">
                                    <Binding ElementName="HudOverlayHost" Path="Bounds.Width" />
                                    <Binding ElementName="HudOverlayHost" Path="Bounds.Height" />
                                </MultiBinding>
                            </ScaleTransform.ScaleY>
                        </ScaleTransform>
                    </ac:LayoutTransformControl.LayoutTransform>

                    <Grid Width="1600" Height="900">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto" />
                            <RowDefinition Height="*" />
                        </Grid.RowDefinitions>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto" />
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="Auto" />
                        </Grid.ColumnDefinitions>

                        <!-- Top bar -->
                        <Border Grid.Row="0"
                                Grid.ColumnSpan="3"
                                Background="Transparent"
                                CornerRadius="8"
                                Padding="8,6"
                                Margin="0,0,0,8"
                                Width="250"
                                MaxWidth="1350"
                                HorizontalAlignment="Center">
                            <Grid ColumnDefinitions="*,Auto,*" VerticalAlignment="Center">
                                <StackPanel Orientation="Horizontal" Spacing="8" VerticalAlignment="Center">
                                    <TextBlock Text="{Binding TeamCt.DisplayName}"
                                               Foreground="#A9D6FF"
                                               FontSize="22"
                                               FontWeight="Bold" >
                                        <TextBlock.Effect>
                                            <DropShadowEffect   
                                                Color="Black"
                                                BlurRadius="5"
                                                OffsetX="2"
                                                OffsetY="2"
                                                Opacity="0.5"/>
                                        </TextBlock.Effect>
                                    </TextBlock>
                                    <Border Background="#22364A"
                                            CornerRadius="6"
                                            Padding="7,2">
                                        <TextBlock Text="{Binding TeamCt.Score}"
                                                   FontSize="18"
                                                   FontWeight="Bold"
                                                   Foreground="#E6E6E6" />
                                    </Border>
                                </StackPanel>

                                <StackPanel Grid.Column="1"
                                            Orientation="Vertical"
                                            Spacing="2"
                                            HorizontalAlignment="Center">
                                    <TextBlock Text="{Binding RoundPhase}"
                                               Foreground="#E6E6E6"
                                               FontWeight="SemiBold"
                                               FontSize="12"
                                               HorizontalAlignment="Center" >
                                        <TextBlock.Effect>
                                            <DropShadowEffect   
                                                Color="Black"
                                                BlurRadius="5"
                                                OffsetX="2"
                                                OffsetY="2"
                                                Opacity="0.5"/>
                                        </TextBlock.Effect>
                                    </TextBlock>
                                    <TextBlock Text="{Binding RoundNumber, StringFormat=Round {0}}"
                                               Foreground="#E0E0E0"
                                               FontSize="11"
                                               HorizontalAlignment="Center" >
                                        <TextBlock.Effect>
                                            <DropShadowEffect   
                                                Color="Black"
                                                BlurRadius="5"
                                                OffsetX="2"
                                                OffsetY="2"
                                                Opacity="0.5"/>
                                        </TextBlock.Effect>
                                    </TextBlock>
                                    <TextBlock Text="{Binding RoundTimerText}"
                                               Foreground="#FFFFFF"
                                               FontSize="26"
                                               FontWeight="Black"
                                               HorizontalAlignment="Center" >
                                        <TextBlock.Effect>
                                            <DropShadowEffect   
                                                Color="Black"
                                                BlurRadius="5"
                                                OffsetX="2"
                                                OffsetY="2"
                                                Opacity="0.5"/>
                                        </TextBlock.Effect>
                                    </TextBlock>
                                </StackPanel>

                                <StackPanel Grid.Column="2"
                                            Orientation="Horizontal"
                                            Spacing="8"
                                            HorizontalAlignment="Right"
                                            VerticalAlignment="Center">
                                    <Border Background="#332514"
                                            CornerRadius="6"
                                            Padding="7,2">
                                        <TextBlock Text="{Binding TeamT.Score}"
                                                   FontSize="18"
                                                   FontWeight="Bold"
                                                   Foreground="#E6E6E6" />
                                    </Border>
                                    <TextBlock Text="{Binding TeamT.DisplayName}"
                                               Foreground="#FFB271"
                                               FontSize="22"
                                               FontWeight="Bold" >
                                        <TextBlock.Effect>
                                            <DropShadowEffect   
                                                Color="Black"
                                                BlurRadius="5"
                                                OffsetX="2"
                                                OffsetY="2"
                                                Opacity="0.5"/>
                                        </TextBlock.Effect>
                                    </TextBlock>
                                </StackPanel>
                            </Grid>
                        </Border>

                        <!-- Player sidebars -->
                        <ItemsControl Grid.Row="1"
                                      Grid.Column="0"
                                      ItemsSource="{Binding TeamCt.Players}"
                                      ItemTemplate="{StaticResource PlayerCardTemplate}"
                                      Margin="0,4,16,12">
                            <ItemsControl.ItemsPanel>
                                <ItemsPanelTemplate>
                                    <StackPanel HorizontalAlignment="Left" VerticalAlignment="Bottom"/>
                                </ItemsPanelTemplate>
                            </ItemsControl.ItemsPanel>
                        </ItemsControl>

                        <ItemsControl Grid.Row="1"
                                      Grid.Column="2"
                                      ItemsSource="{Binding TeamT.Players}"
                                      ItemTemplate="{StaticResource PlayerCardTemplate}"
                                      Margin="16,4,0,12">
                            <ItemsControl.ItemsPanel>
                                <ItemsPanelTemplate>
                                    <StackPanel HorizontalAlignment="Right" VerticalAlignment="Bottom"/>
                                </ItemsPanelTemplate>
                            </ItemsControl.ItemsPanel>
                        </ItemsControl>

                        <TextBlock Grid.Row="1"
                                   Grid.Column="1"
                                   Text="Waiting for HUD data..."
                                   Foreground="#9AA4B5"
                                   HorizontalAlignment="Center"
                                   VerticalAlignment="Center"
                                   IsVisible="{Binding HasHudData, Converter={StaticResource BooleanNegationConverter}}" />

                        <!-- Focused player overlay (doesn't reduce sidebars height) -->
                        <ContentControl Grid.Row="1"
                                        Grid.ColumnSpan="3"
                                        HorizontalAlignment="Center"
                                        VerticalAlignment="Bottom"
                                        Margin="0,0,0,8"
                                        Width="520"
                                        IsVisible="{Binding HasFocusedHudPlayer}"
                                        Content="{Binding FocusedHudPlayer}"
                                        ContentTemplate="{StaticResource PlayerCardTemplate}" />
                    </Grid>
                </ac:LayoutTransformControl>
            </Grid>
        </Grid>

        <!-- No signal overlay -->
        <Border Grid.Row="0"
                Background="#1A1A1A"
                IsVisible="{Binding ShowNoSignal}">
            <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center">
                <TextBlock Text="No Signal"
                           FontSize="24"
                           FontWeight="Bold"
                           Foreground="#666666"
                           HorizontalAlignment="Center"
                           Margin="0,0,0,10"/>
                <TextBlock Text="Start RTP/Local Mode to display video"
                           FontSize="14"
                           Foreground="#888888"
                           HorizontalAlignment="Center"/>
            </StackPanel>
        </Border>

        <!-- Status bar -->
        <Border Grid.Row="1" Background="#2D2D30" Padding="8,4">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <TextBlock Grid.Column="0"
                           Text="{Binding StatusText}"
                           Foreground="#CCCCCC"
                           VerticalAlignment="Center"/>

                <TextBlock Grid.Column="1"
                           Foreground="#CCCCCC"
                           VerticalAlignment="Center"
                           Margin="10,0">
                    <Run Text="FPS: "/>
                    <Run Text="{Binding FrameRate, StringFormat={}{0:F1}}"/>
                </TextBlock>

                <StackPanel Grid.Column="2" Orientation="Horizontal" Spacing="6" VerticalAlignment="Center">
                    <CheckBox Content="Local Mode"
                              Margin="0,0,15,0"
                              IsChecked="{Binding UseD3DHost}"
                              ToolTip.Tip="Render shared texture directly on GPU (no CPU copy)"
                              Focusable="False"/>
                </StackPanel>

                <StackPanel Grid.Column="3" Orientation="Horizontal" Spacing="5">
                    <TextBlock Text="RTP Stream:" VerticalAlignment="Center" Foreground="#CCCCCC"/>
                    <Button Content="Start"
                            Click="StartButton_Click"
                            IsEnabled="{Binding CanStart}"
                            Padding="10,5"/>
                    <Button Content="Stop"
                            Click="StopButton_Click"
                            IsEnabled="{Binding CanStop}"
                            Padding="10,5"/>
                    <Button Content="Refresh Binds"
                            Click="RefreshBindsButton_Click"
                            Padding="10,5"
                            ToolTip.Tip="Refresh spectator bindings (1-5: CT, 6-0: T)"/>
                </StackPanel>
            </Grid>
        </Border>
    </Grid>
</UserControl>
